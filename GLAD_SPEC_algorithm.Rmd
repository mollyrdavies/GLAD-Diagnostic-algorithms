---
title: "Lifetime DSM-5 specific phobia: Diagnostic algorithm (GLAD Study data)"
author: "Molly Davies"
date: "22/10/20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up

Clear workspace
```{r clear workspace}
#rm(list = ls())
```

```{r load packages}
library(knitr)
library(tidyverse)
library(car)
library(psych)
library(lubridate)
library(broom)
library(ggfortify)
library(summarytools)
library(ggformula)
library(data.table)
```

```{r source path for reading/saving data}
#Source raw data directory (raw_path) & clean data export directory (cleaned_path)
source("../GLAD_data_path.R")
```

```{r read in cleaned SPEC data}
SPEC_file <- paste(raw_path, "SPEC.rds", sep = "")

SPEC.cc <- read_rds(SPEC_file)
```

```{r visualize data}
head(SPEC.cc)
```

```{r create dataset of SPEC diagnostic variables}
SPEC.items <- SPEC.cc %>%
  select(ID,
        spec.vomit_phobia,
        spec.environment_phobia,
        spec.situation_phobia,
        spec.animal_phobia,
        spec.blood_injection_phobia,
        spec.other_phobia,
        spec.avoid_phobias,
        spec.endure_phobias_with_anxiety,
        spec.phobia_frequency,
        spec.age_first_phobia,
        spec.age_most_recent_phobia,
        spec.phobia_lasted,
        spec.phobia_interfered,
        spec.phobia_out_of_proportion)
```

```{r recode as NAs}
#Change all prefer not to answers and don't knows to NA
SPEC.items[SPEC.items == "Don't know"] <- NA
SPEC.items[SPEC.items == "Prefer not to answer"] <- NA
SPEC.items[SPEC.items == "Seen but not answered"] <- NA
```

# DSM-5 Specific phobia diagnostic criteria

A.  Marked fear or anxiety about a specific object or situation (e.g., flying, heights, animals, receiving an injection, seeing blood). 

B.  The phobic object or situation almost always provokes immediate fear or anxiety.

C.  The phobic object or situation is actively avoided or endured with intense fear or anxiety.

D.  The fear or anxiety is out of proportion to the actual danger posed by the specific objector situation and to the sociocultural context.

E.  The fear, anxiety, or avoidance is persistent, typically lasting for 6 months or more.

F.   The fear, anxiety, or avoidance causes clinically significant distress* or impairment in social, occupational, or other important areas of functioning.

G.  The  disturbance is not better explained by the symptoms of another mental disorder, including fear, anxiety, and avoidance of situations associated with panic-like symptoms or other  incapacitating  symptoms (as in agoraphobia): objects or situations related to obsessions (as in obsessive-compulsive disorder); reminders of traumatic events (as in posttraumatic stress disorder); separation from home or attachment figures (as in sepÂ¬aration anxiety disorder); or social situations (as in social anxiety disorder).*


*The questionnaire doesn't adequately measure significant distress or criterion G.

## Screening variables
The specific phobia section screening questions include:
1) At least one phobia (criterion A) must be endorsed
2) Frequency of these fears (criterion B) are almost always or always present when exposed to the phobia


*How the screening questions work*
If participants answer 'No' to all phobias in criterion A, then they are given a 0 for diagnosis and skip the remaining questions.

If participants answer 'Yes' to any phobia in criterion A but report frequency of these fears as "Never", "Only one or two times ever", or "Some of the time", then they are given a 0 for diagnosis and skip the remaining questions.

```{r specific phobia screener}
#Criterion A screening variable
SPEC.items <- SPEC.items %>% 
  mutate(specific_phobia_screener_numeric = 
           case_when(
             spec.environment_phobia == "No" & spec.situation_phobia == "No" & spec.animal_phobia == "No" & spec.blood_injection_phobia == "No" & spec.other_phobia == "No" ~ 0,
             !is.na(spec.phobia_frequency) & (spec.phobia_frequency == "Never" | spec.phobia_frequency == "Only one or two times ever" | spec.phobia_frequency == "Some of the time") ~ 0,
             spec.environment_phobia == "Yes" | spec.situation_phobia == "Yes" | spec.animal_phobia == "Yes" | spec.blood_injection_phobia == "Yes" | spec.other_phobia == "Yes" & (spec.phobia_frequency == "Almost always" | spec.phobia_frequency == "Always") ~ 1,
             is.na(spec.environment_phobia) & is.na(spec.situation_phobia) & is.na(spec.animal_phobia) & is.na(spec.blood_injection_phobia) & is.na(spec.other_phobia) | is.na(spec.phobia_frequency) ~ NA_real_
           ))
#Criterion A screening variable (NA coded as 0)
## This variable is created to remove NAs solely for the purpose of coding the variable in the following chunk (spec.specific_phobia_screen.calc.NA)
SPEC.items$specific_phobia_screener_numeric_noNA <- with(SPEC.items,
                                        ifelse(is.na(specific_phobia_screener_numeric), 0, specific_phobia_screener_numeric))

summary(as.factor(SPEC.items$specific_phobia_screener_numeric))
summary(as.factor(SPEC.items$specific_phobia_screener_numeric_noNA))
```

# DSM-5 specific phobia algorithm
Applying the diagnostic algorithm to questionnaire responses
```{r diagnostic algorithm for specific phobia}
SPEC.items <- SPEC.items %>% 
  mutate(specific_phobia_any_numeric =
           case_when(
#No phobia
        #Criterion A (not met)
             (spec.environment_phobia == "No" & spec.situation_phobia == "No" & spec.animal_phobia == "No" & spec.blood_injection_phobia == "No" & spec.other_phobia == "No") |
        #Criterion E. Frequency (not met)
          (spec.phobia_frequency == "Never" | spec.phobia_frequency == "Only one or two times ever" | spec.phobia_frequency == "Some of the time") |
        #Criterion D. Out of proportion (not met)
          spec.phobia_out_of_proportion == "No" | 
        #Criterion E. Duration (not met)
          (spec.phobia_lasted == "Less than 6 months") | 
        #Criterion F. Functional impairment (not met)
          (spec.phobia_interfered == "Not at all" | spec.phobia_interfered == "A little") | 
        #Criterion C. Avoid or endure (not met)
          (spec.avoid_phobias == "No" & spec.endure_phobias_with_anxiety == "No") ~ 0, 
#Any phobia
        #Criterion A
             (spec.environment_phobia == "Yes" | spec.situation_phobia == "Yes" | spec.animal_phobia == "Yes" | spec.blood_injection_phobia == "Yes" | spec.other_phobia == "Yes") &
        #Criterion E. Frequency
          (spec.phobia_frequency == "Almost always" | spec.phobia_frequency == "Always") & 
        #Criterion D. Out of proportion
          spec.phobia_out_of_proportion == "Yes" &
        #Criterion E. Duration
      (spec.phobia_lasted == "6 - 12 months" | spec.phobia_lasted == "1 - 5 years" | spec.phobia_lasted == "5+ years" 
       | spec.phobia_lasted == "All my life") & 
        #Criterion F. Functional impairment
        (spec.phobia_interfered == "Some" | spec.phobia_interfered == "A lot") &
        #Criterion C. Avoid or endure
        (spec.avoid_phobias == "Yes" | spec.endure_phobias_with_anxiety == "Yes") ~ 1)) #Criterion C. Avoid or endure

#Get frequencies
freq(SPEC.items$specific_phobia_any_numeric)
```

## Missingness

*Screening missingness variable:*
If participants do not respond to one of the screening questions, then they are not shown the remaining questions and should autmatically have "NA" as their score.

For criterion B, NA is only counted if criterion A is 1 (since otherwise the question was not displayed).
```{r specific phobia screeners NA count score}
SPEC.items$spec.specific_phobia_screen.calc.NA<-0
#If any criterion A (screening criteria) are NA (and diagnostic status is 0)
SPEC.items$spec.specific_phobia_screen.calc.NA<-with(SPEC.items, 
                                    ifelse(
                                      (specific_phobia_any_numeric == 0 | is.na(specific_phobia_any_numeric)) & 
                                        (is.na(spec.environment_phobia) | is.na(spec.situation_phobia) | is.na(spec.animal_phobia) | is.na(spec.blood_injection_phobia) | is.na(spec.other_phobia)), 
                                           spec.specific_phobia_screen.calc.NA + 1, spec.specific_phobia_screen.calc.NA))
#If criterian B (almost always provoking fear) is NA, but criterion A was met
SPEC.items$spec.specific_phobia_screen.calc.NA<-with(SPEC.items,
                                    ifelse(specific_phobia_screener_numeric_noNA == 1 & is.na(spec.phobia_frequency),
                                           spec.specific_phobia_screen.calc.NA + 1, spec.specific_phobia_screen.calc.NA))

summary(as.factor(SPEC.items$spec.specific_phobia_screen.calc.NA))
```

*Symptom missingness variable:*
Similarly, once participants pass the screeners, if any of the other core symptoms are NA then the participant might have received a diagnosis of specific phobia, but we won't know. 

Future considerations: If a participant has an NA in this score but was far from meeting diagnostic criteria, then we may still want to keep them as a '0' for diagnosis.
```{r specific phobia NA symptom count score}

SPEC.items$spec.specific_phobia_symptoms.calc.NA<-0
#If criterion D is NA
SPEC.items$spec.specific_phobia_symptoms.calc.NA<-with(SPEC.items, 
                                    ifelse(specific_phobia_screener_numeric_noNA == 1 & is.na(spec.phobia_out_of_proportion), 
                                           spec.specific_phobia_symptoms.calc.NA + 1, spec.specific_phobia_symptoms.calc.NA))

#If criterion F (functional impairment) is NA
SPEC.items$spec.specific_phobia_symptoms.calc.NA<-with(SPEC.items,
                                    ifelse(specific_phobia_screener_numeric_noNA == 1 & is.na(spec.phobia_interfered),
                                           spec.specific_phobia_symptoms.calc.NA + 1, spec.specific_phobia_symptoms.calc.NA))
#If both items for criterion C (avoid or endure) are NA
SPEC.items$spec.specific_phobia_symptoms.calc.NA<-with(SPEC.items, 
                                    ifelse(specific_phobia_screener_numeric_noNA == 1 & is.na(spec.avoid_phobias) & is.na(spec.endure_phobias_with_anxiety), 
                                           spec.specific_phobia_symptoms.calc.NA + 1, spec.specific_phobia_symptoms.calc.NA))

summary(as.factor(SPEC.items$spec.specific_phobia_symptoms.calc.NA))

```

Ppts are coded NA if they didn't respond to questions that could have met diagnostic criteria.
```{r recode any phobia missingness as NA}
#Frequencies before accounting for missingness
freq(SPEC.items$specific_phobia_any_numeric)

#Recode as NA for missingness
SPEC.items$specific_phobia_any_numeric <- with(SPEC.items,
                                       ifelse(
                                         spec.specific_phobia_screen.calc.NA == 1 | 
                                           spec.specific_phobia_symptoms.calc.NA > 0,
                                         NA, specific_phobia_any_numeric
                                       ))

#Frequencies after accounting for missingness
freq(SPEC.items$specific_phobia_any_numeric)

```

An extra check is completed below to ensure that no participants that didn't meet screening criteria were coded as NA.
```{r recode any phobia as 0 if didn't meet screening criteria}
SPEC.items$specific_phobia_any_numeric <- with(SPEC.items,
                                    ifelse((!is.na(spec.environment_phobia) & spec.environment_phobia == "No" & 
                                             !is.na(spec.situation_phobia) & spec.situation_phobia == "No" & 
                                             !is.na(spec.animal_phobia) & spec.animal_phobia == "No" &
                                             !is.na(spec.blood_injection_phobia) & spec.blood_injection_phobia == "No" & 
                                             !is.na(spec.other_phobia) & spec.other_phobia == "No"), 0, specific_phobia_any_numeric))


#Get frequencies
freq(SPEC.items$specific_phobia_any_numeric)

```

```{r recode any phobia as a factor}
#Recode any phobia variable and change variable name
SPEC.items$spec.diagnosis <- recode_factor(SPEC.items$specific_phobia_any_numeric,
                             "0" = "No phobia",
                             "1" = "Any specific phobia"
                             )
#Rename numeric variable
SPEC.items$spec.diagnosis_numeric <- SPEC.items$specific_phobia_any_numeric
```

# Create individual specific phobia variables

```{r individual specific phobia variables}
#Environmental phobia
SPEC.items <- SPEC.items %>% 
  mutate(spec.environment_phobia_diagnosis_numeric = 
           case_when(
             spec.environment_phobia == "Yes" & spec.diagnosis_numeric == 1 ~ 0,
             spec.environment_phobia == "No" & spec.diagnosis_numeric == 1 ~ 0,
             spec.diagnosis_numeric == 0 ~ 0,
             is.na(spec.diagnosis_numeric) ~ NA_real_,
             is.na(spec.environment_phobia) ~ NA_real_
           ))
## Recode factor
SPEC.items <- SPEC.items %>% 
  mutate(spec.environment_phobia_diagnosis =
           recode_factor(spec.environment_phobia_diagnosis_numeric,
                         "0" = "No environment phobia",
                         "1" = "Environment phobia"))
#Situational phobia
SPEC.items <- SPEC.items %>% 
  mutate(spec.situation_phobia_diagnosis_numeric = 
           case_when(
             spec.situation_phobia == "Yes" & spec.diagnosis_numeric == 1 ~ 0,
             spec.situation_phobia == "No" & spec.diagnosis_numeric == 1 ~ 0,
             spec.diagnosis_numeric == 0 ~ 0,
             is.na(spec.diagnosis_numeric) ~ NA_real_,
             is.na(spec.situation_phobia) ~ NA_real_
           ))
## Recode factor
SPEC.items <- SPEC.items %>% 
  mutate(spec.situation_phobia_diagnosis =
           recode_factor(spec.situation_phobia_diagnosis_numeric,
                         "0" = "No situation phobia",
                         "1" = "Situation phobia"))
#Animal phobia
SPEC.items <- SPEC.items %>% 
  mutate(spec.animal_phobia_diagnosis_numeric = 
           case_when(
             spec.animal_phobia == "Yes" & spec.diagnosis_numeric == 1 ~ 0,
             spec.animal_phobia == "No" & spec.diagnosis_numeric == 1 ~ 0,
             spec.diagnosis_numeric == 0 ~ 0,
             is.na(spec.diagnosis_numeric) ~ NA_real_,
             is.na(spec.animal_phobia) ~ NA_real_
           ))
## Recode factor
SPEC.items <- SPEC.items %>% 
  mutate(spec.animal_phobia_diagnosis =
           recode_factor(spec.animal_phobia_diagnosis_numeric,
                         "0" = "No animal phobia",
                         "1" = "Animal phobia"))
#Blood injection phobia
SPEC.items <- SPEC.items %>% 
  mutate(spec.blood_injection_phobia_diagnosis_numeric = 
           case_when(
             spec.blood_injection_phobia == "Yes" & spec.diagnosis_numeric == 1 ~ 0,
             spec.blood_injection_phobia == "No" & spec.diagnosis_numeric == 1 ~ 0,
             spec.diagnosis_numeric == 0 ~ 0,
             is.na(spec.diagnosis_numeric) ~ NA_real_,
             is.na(spec.blood_injection_phobia) ~ NA_real_
           ))
## Recode factor
SPEC.items <- SPEC.items %>% 
  mutate(spec.blood_injection_phobia_diagnosis =
           recode_factor(spec.blood_injection_phobia_diagnosis_numeric,
                         "0" = "No blood or injection phobia",
                         "1" = "Blood or injection phobia"))
#Other phobia
SPEC.items <- SPEC.items %>% 
  mutate(spec.other_phobia_diagnosis_numeric = 
           case_when(
             spec.other_phobia == "Yes" & spec.diagnosis_numeric == 1 ~ 0,
             spec.other_phobia == "No" & spec.diagnosis_numeric == 1 ~ 0,
             spec.diagnosis_numeric == 0 ~ 0,
             is.na(spec.diagnosis_numeric) ~ NA_real_,
             is.na(spec.other_phobia) ~ NA_real_
           ))
## Recode factor
SPEC.items <- SPEC.items %>% 
  mutate(spec.other_phobia_diagnosis =
           recode_factor(spec.other_phobia_diagnosis_numeric,
                         "0" = "No other phobia",
                         "1" = "Other phobia"))
```

# Clean SPEC dataset
```{r clean SPEC dataframe}
SPEC.clean <- SPEC.items %>%
  select(ID,
        spec.vomit_phobia,
        spec.environment_phobia,
        spec.situation_phobia,
        spec.animal_phobia,
        spec.blood_injection_phobia,
        spec.other_phobia,
        spec.avoid_phobias,
        spec.endure_phobias_with_anxiety,
        spec.phobia_frequency,
        spec.age_first_phobia,
        spec.age_most_recent_phobia,
        spec.phobia_lasted,
        spec.phobia_interfered,
        spec.phobia_out_of_proportion,
        spec.environment_phobia_diagnosis_numeric,
        spec.environment_phobia_diagnosis,
        spec.situation_phobia_diagnosis_numeric,
        spec.situation_phobia_diagnosis,
        spec.animal_phobia_diagnosis_numeric,
        spec.animal_phobia_diagnosis,
        spec.blood_injection_phobia_diagnosis_numeric,
        spec.blood_injection_phobia_diagnosis,
        spec.other_phobia_diagnosis_numeric,
        spec.other_phobia_diagnosis,
        spec.diagnosis,
        spec.diagnosis_numeric)

#Export data
saveRDS(object = SPEC.clean, file = paste0(cleaned_path, "SPEC_cleaned.rds"))

# Save the R data including the recoding
#save.image(file = paste0(cleaned_path, "GLAD_SPEC_clean.RData"))
```